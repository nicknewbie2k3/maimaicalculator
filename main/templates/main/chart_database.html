{% extends 'main/base.html' %}
{% block title %}Chart Database{% endblock %}
{% block content %}
  <!-- Bootstrap CSS CDN (if not already in base.html) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <div class="container-fluid my-4" style="max-width:150vw;">
    <h1 class="text-center mb-4">Maimai Chart Database</h1>

    <!-- Filter Form -->
    <form method="get" class="row g-2 mb-4" autocomplete="off">
      <div class="col-md-2 position-relative">
        <input type="text" class="form-control" id="filter_title" name="title" placeholder="Song Name" value="{{ request.GET.title|default_if_none:'' }}" autocomplete="off" oninput="showDropdown('title')">
        <div id="dropdown-title" class="dropdown-menu" style="display:none; max-height:200px; overflow-y:auto; width:100%;"></div>
      </div>
      <div class="col-md-2 position-relative">
        <input type="text" class="form-control" id="filter_version" name="version" placeholder="Version" value="{{ request.GET.version|default_if_none:'' }}" autocomplete="off" oninput="showDropdown('version')">
        <div id="dropdown-version" class="dropdown-menu" style="display:none; max-height:200px; overflow-y:auto; width:100%;"></div>
      </div>
      <div class="col-md-2 position-relative">
        <input type="text" class="form-control" id="filter_artist" name="artist" placeholder="Artist" value="{{ request.GET.artist|default_if_none:'' }}" autocomplete="off" oninput="showDropdown('artist')">
        <div id="dropdown-artist" class="dropdown-menu" style="display:none; max-height:200px; overflow-y:auto; width:100%;"></div>
      </div>
      <div class="col-md-2 position-relative">
        <select class="form-select" id="filter_catcode" name="catcode">
          <option value="">Catcode</option>
          <option value="ANIME" {% if request.GET.catcode == "ANIME" %}selected{% endif %}>ANIME</option>
          <option value="niconico＆VOCALOID™" {% if request.GET.catcode == "niconico＆VOCALOID™" %}selected{% endif %}>niconico＆VOCALOID™</option>
          <option value="東方Project" {% if request.GET.catcode == "東方Project" %}selected{% endif %}>東方Project</option>
          <option value="GAME＆VARIETY" {% if request.GET.catcode == "GAME＆VARIETY" %}selected{% endif %}>GAME＆VARIETY</option>
          <option value="maimai" {% if request.GET.catcode == "maimai" %}selected{% endif %}>maimai</option>
          <option value="オンゲキ＆CHUNITHM" {% if request.GET.catcode == "オンゲキ＆CHUNITHM" %}selected{% endif %}>オンゲキ＆CHUNITHM</option>
          <option value="宴会場" {% if request.GET.catcode == "宴会場" %}selected{% endif %}>宴会場</option>
        </select>
      </div>
      <div class="col-md-2 position-relative">
        <select class="form-select" id="filter_chart_type" name="chart_type">
          <option value="">Chart Type</option>
          <option value="STD" {% if request.GET.chart_type == "STD" %}selected{% endif %}>STD</option>
          <option value="DX" {% if request.GET.chart_type == "DX" %}selected{% endif %}>DX</option>
        </select>
      </div>
      <div class="col-md-2 position-relative">
        <select class="form-select" id="filter_difficulty" name="difficulty">
          <option value="">Difficulty</option>
          <option value="Basic" {% if request.GET.difficulty == "Basic" %}selected{% endif %}>Basic</option>
          <option value="Advanced" {% if request.GET.difficulty == "Advanced" %}selected{% endif %}>Advanced</option>
          <option value="Expert" {% if request.GET.difficulty == "Expert" %}selected{% endif %}>Expert</option>
          <option value="Master" {% if request.GET.difficulty == "Master" %}selected{% endif %}>Master</option>
          <option value="Re:Master" {% if request.GET.difficulty == "Re:Master" %}selected{% endif %}>Re:Master</option>
        </select>
      </div>
      <div class="col-md-12 mt-2">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{% url 'chart_database' %}" class="btn btn-secondary">Reset</a>
      </div>
    </form>

    <script>
      // Prepare unique lists for dropdowns (passed from Django context)
      const filterData = {
        title: [
          {% for v in filter_titles %}"{{ v|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        version: [
          {% for v in filter_versions %}"{{ v|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        artist: [
          {% for v in filter_artists %}"{{ v|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ]
      };

      function showDropdown(field) {
        const input = document.getElementById('filter_' + field);
        const dropdown = document.getElementById('dropdown-' + field);
        const value = input.value.trim().toLowerCase();
        dropdown.innerHTML = '';
        if (!value) {
          dropdown.style.display = 'none';
          return;
        }
        const matches = filterData[field].filter(option => option.toLowerCase().includes(value));
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        matches.forEach(optionText => {
          const option = document.createElement('button');
          option.type = 'button';
          option.className = 'dropdown-item';
          option.textContent = optionText;
          option.onclick = function() {
            input.value = optionText;
            dropdown.style.display = 'none';
          };
          dropdown.appendChild(option);
        });
        dropdown.style.display = 'block';
      }

      // Hide dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        ['title','version','artist'].forEach(function(field) {
          const input = document.getElementById('filter_' + field);
          const dropdown = document.getElementById('dropdown-' + field);
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
      });
    </script>

    <!-- Show number of results -->
    <div class="mb-2">
      <strong>{{ songs.paginator.count }}</strong> result{{ songs.paginator.count|pluralize }} found.
    </div>

    <div class="table-responsive" style="overflow-x:auto;">
      <table class="table table-striped table-bordered align-middle w-100">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Title Kana</th>
            <th>Artist</th>
            <th>Catcode</th>
            <th>Image</th>
            <th>Release</th>
            <th>Level Basic</th>
            <th>Level Advanced</th>
            <th>Level Expert</th>
            <th>Level Master</th>
            <th>Level Re:Master</th>
            <th>Sort</th>
            <th>Version</th>
            <th>Chart Type</th>
          </tr>
        </thead>
        <tbody>
          {% for song in songs %}
          <tr>
            <td>{{ forloop.counter0|add:songs.start_index }}</td>
            <td>{{ song.title }}</td>
            <td>{{ song.title_kana }}</td>
            <td>{{ song.artist }}</td>
            <td>{{ song.catcode }}</td>
            <td>
              {% if song.image_url %}
                <a href="{{ song.image_url }}" target="_blank">
                  <img src="{{ song.image_url }}" alt="Image" style="height:40px; max-width:60px; border-radius:4px;">
                </a>
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ song.release }}</td>
            <td>{{ song.lev_bas }}</td>
            <td>{{ song.lev_adv }}</td>
            <td>{{ song.lev_exp }}</td>
            <td>{{ song.lev_mas }}</td>
            <td>{{ song.lev_remas }}</td>
            <td>{{ song.sort }}</td>
            <td>{{ song.version }}</td>
            <td>{{ song.chart_type }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="15" class="text-center">No songs found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if songs.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page=' }}&{% endif %}page=1">&laquo; First</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page=' }}&{% endif %}page={{ songs.previous_page_number }}">&lsaquo; Prev</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
          <li class="page-item disabled"><span class="page-link">&lsaquo; Prev</span></li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">
            Page {{ songs.number }} of {{ songs.paginator.num_pages }}
          </span>
        </li>
        {% if songs.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page=' }}&{% endif %}page={{ songs.next_page_number }}">Next &rsaquo;</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page=' }}&{% endif %}page={{ songs.paginator.num_pages }}">Last &raquo;</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next &rsaquo;</span></li>
          <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
{% endblock %}